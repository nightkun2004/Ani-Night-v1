<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
         <%= video.name %>
    </title>
    <meta name="description" content="<%= video.description %>  | Ani Night">
    <link rel="shortcut icon" href="/images/logo/Aninight.png" type="image/x-icon">
    <meta name="keywords" content="anime, Anime, อนิเมะ, <%= video.name %>, <%= video.categories %>">
    <meta name="author" content="aninight by Night">
    <meta property="og:title" content="<%= video.name %> | AniNight">
    <% if (video && video.tags && video.tags.length> 0) { %>
        <meta name="keywords" content="<%- video.tags.map(tag => tag).join(', ') %>">
        <% } else { %>
            <h2>Tags: ไม่มีแท็ก</h2>
            <% } %>
                <meta property="og:description" content="<%= video.description %>">
                <meta property="og:image" content="https://ani-night.online/videos/<%= video.filePath %>.mp4">
                <meta property="og:url" content="https://ani-night.online">
                <meta property="og:type" content="website">

                <meta name="title" content="<%= video.name %> " />
                <meta name="description" content="<%= video.description %>  | Ani Night" />


                <!-- Open Graph / Facebook -->
                <meta property="og:type" content="website" />
                <meta property="og:url" content="https://ani-night.online/play/32140" />
                <meta property="og:title" content="<%= video.name %>" />
                <meta property="og:description" content="<%= video.description %>  | Ani Night" />
                <meta property="og:image" content="https://ani-night.online/cover_videos/<%= video.coverImage %>" />


                <!-- Twitter -->
                <meta property="twitter:card" content="summary_large_image" />
                <meta property="twitter:url" content="https://ani-night.online/play/32140" />
                <meta property="twitter:title" content="<%= video.name %>" />
                <meta property="twitter:description" content="<%= video.description %>  | Ani Night" />
                <meta property="twitter:image" content="https://ani-night.online/cover_videos/<%= video.coverImage %>" />
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6579807593228261"
                    crossorigin="anonymous"></script>
                <script async custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js"></script>
                <script src="https://cdn.tailwindcss.com"></script>
                <link rel="stylesheet" href="../../css/play.css">
                <link rel="stylesheet" href="../../../css/play.css">
                <link rel="stylesheet" href="../../css/footer.css">
                <link rel="stylesheet" href="../../../css/footer.css">
                <link rel="stylesheet" href="../../css/font/font1.css">
                <link rel="stylesheet" href="../../../css/font/font1.css">
                <link rel="stylesheet" href="../../css/pages/video_player.css">
                <link rel="stylesheet" href="../../../css/pages/video_player.css">
                <link rel="stylesheet" type="text/css"
                    href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.css" />
                <script type="text/javascript" src="/js/index.js"></script>
                <link rel="stylesheet"
                    href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick-theme.min.css"
                    integrity="sha512-17EgCFERpgZKcm0j0fEq1YCJuyAWdz9KUtv1EjVuaOz8pDnh/0nZxmU6BBXwaaxqoi9PQXnRWqlcDB027hgv9A=="
                    crossorigin="anonymous" referrerpolicy="no-referrer" />
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.css"
                    integrity="sha512-yHknP1/AwR+yx26cB1y0cjvQUMvEa2PFzt1c9LlS4pRQ5NOTZFWbhBig+X9G9eYW/8m0/4OXNx8pxJ6z57x0dw=="
                    crossorigin="anonymous" referrerpolicy="no-referrer" />
                <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet" />
                <link rel="stylesheet"
                    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
                <link rel="stylesheet"
                    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
                <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100">
    <%- include('../navnar_Header') %>
    <%- include('../sidebar_Section') %>
    <section class="player_anime-container max-w-7xl mx-auto sm:px-6 lg:px-8">
        <!-- Section Left -->
        <div class="container-play" >
            <section class="section-player md:p-2">
                <div class="container">
                    <div class="video_player" data-video-id="<%= video._id %>">
                        <video webkit-playsinline playsinline preload="metadata" 
                        <% if (video.coverImage) {%>
                            poster="/cover_videos/<%= video.coverImage %>"
                        <% } %>
                        class="main-video" id="video">
                            <source src="/videos/<%= video.filePath %>.mp4" size="720" type="video/mp4">

                            <% if (video.subthai) { %>
                                <track default label="ซับไทย" kind="subtitles" src="../subtitles/<%= video.subthai %>"
                                    srclang="th">
                                <% } %>
                        </video>
                        <div id="comments-container" class="comments-container"></div>
                        <div class="watermark">
                            <h3>AniNight</h3>
                        </div>
                        <div id="ad-container"></div>
                    </div>
                </div>
                <div class="comment-sky bg-white text-black flex p-3">
                    <div id="settings" class="hidden md:flex md:justify-start md:items-center md:block">
                        <label for="speed-input">ความเร็วของความคิดเห็น (วินาที):</label>
                        <input type="number" id="speed-input" class="w-1/2 outline-none border-2 px-4" value="8" min="1" step="0.5">
                    </div>
                    <form id="comment-form" class="flex flex-row">
                        <input type="text" id="comment-input" class="w-full outline-none" placeholder="พิมพ์ความคิดเห็นลอยของคุณที่นี่...">
                        <button class="bg-sky-500 rounded p-2" type="submit">ส่งความคิดเห็น</button>
                    </form>
                    <%- include('./js/videoPlayer') %>
                </div>

                <!-- info Mobile -->
                <div class="bg-white text-black mt-5 px-6 md:px-12 py-4 shadow-md rounded-md relative">
                    <div class="tages">
                        <% if (video && video.tags && video.tags.length> 0) { %>
                            <h2> <%- video.tags.map(tag=> `<a class="bg-gray-100 rounded p-1" href="/tag/${tag}">${tag}</a>`).join(', ') %></h2>
                            <% } else { %>
                                <h2>Tags: ไม่มีแท็ก</h2>
                                <% } %>
                    </div>
                    <h2 class="text-2xl font-bold mt-2 text-black flex">
                        <%= video.name %>
                    </h2>
                     <!-- Description -->
                <div class="description text-black mt-8">
                    <div class="flex text-gray-400">
                        <% if (video && video.createdAt) { %>
                            <p>เผยแพร่เมื่อ : <%= new Date(video.createdAt).toLocaleDateString('en-EN') %></p>
                            <p class="views-pc pl-2">การดู <%= video.views %> ครั้ง</p>
                            <% } %>
                    </div>
                    <p>
                        <% if(video.description.length <=50) { %>
                            <%= video.description %>
                                <% } else { %>
                                    <span class="short-text">
                                        <%- video.description.substring(0, 50) + '  ....' %>
                                    </span>
                
                                    <span class="full-text" style="display: none;">
                                        <%- video.description %>
                                    </span>
                                    <span class="more-btn">ดูเพิ่มเติม</span>
                                    <span class="less-btn" style="display: none;">ย่อ</span>
                                    <% } %>
                    </p>
                </div>
                </div>


                

                <div class="Mobile">
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6579807593228261"
                        crossorigin="anonymous"></script>
                    <!-- Ads12 -->
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6579807593228261" data-ad-slot="3343866175"
                        data-ad-format="auto" data-full-width-responsive="true"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>

                <!-- Coment -->
                <div class="mt-8 w-full text-black bg-white px-6 md:px-12 py-4 shadow-md rounded-md relative">
                    <h2 style="font-size: 20px; font-weight: bold;" class="mb-5">ความคิดเห็น</h2>
                    <% if (usersesstion) { %>
                    <form>
                        <div class="comment-box">
                            <input type="hidden" name="video_id" value="<%= video._id %>" readonly>
                            <div class="flex">
                                <div class="m-1 flex items-center justify-center">
                                    <img src="/profiles/<%= usersesstion.profile %>" alt="Profilecomment" class="w-10 rounded-full">
                                </div>
                                <div class="flex flex-col w-full">
                                    <p>
                                        <%= usersesstion.username %>
                                    </p>
                                    <input type="text" name="inputcomment" id="comment" class="custom-input" style="outline: none;"
                                        placeholder="แสดงความคิดเห็น" required>
                                </div>
                            </div>
                            <button data-videoid="<%= video._id %>" class="btn-comment" type="submit">แสดงความคิดเห็น</button>
                        </div>
                    </form>
    
                   <% } else { %>
                    <p>หากคุณต้องการแสดงความคิดเห็นกรุณาเข้าสู่ระบบ <a href="/login" class="pl-3 text-2xl">เข้าสู่ระบบ</a></p>
                  <% } %>
                </div>

                <!-- Coments ALL -->
                <div class="mt-8 w-full text-black bg-white px-6 md:px-12 py-4 shadow-md rounded-md relative">
                    <div class="comment-lists">
                        <% if (video && video.replies) { %>
                            <% const totalReplies = video.replies.length; %>
                            <h2 style="font-weight: bold;" class="mb-6 text-2xl">ความคิดเห็นทั้งหมด: <%= totalReplies %></h2>
                        <% } %>
                      <div class="loading_container">
                        <div class="loader"></div>
                      </div>
                      <div class="loading" style="display: none;">
                        <ul class="comment-list__wrap">
                            <% video.replies.slice().reverse().forEach(comment => { %>
                                <li class="comment-list__wrap__item">
                                    <div class="comment--root comment--pc">
                                        <div class="iconprofile-comment">
                                            <a href="/editor/<%= comment.username.username %>" target="_blank">
                                                <img src="/profiles/<%= comment.username.profile %>" alt="">
                                            </a>
                                        </div>
                                    </div>
                                    <div class="comment__container">
                                        <div class="comment__user">
                                            <a class="comment__name" href="/editor/<%= comment.username.username %>" target="_blank">
                                                <h5><%= comment.username.username %></h5>
                                            </a>
                                           
                                            <span class="comment__time"><%=  moment(comment.createdAt ).locale('th').fromNow() %></span>
                                        </div>
                                        <div class="comment__content">
                                            <span class="comment-content__text"><%= comment.content %></span>
                                        </div>
                                        <div class="comment__operate">
                                            <div class="comment__operate__item">
                                                <form>
                                                    <i class="fa-regular fa-thumbs-up" data-video-id="<%= video._id %>" data-commentId="<%= comment._id %>"></i> 
                                                    <span class="text-1xl likes-count"><%= comment.likes %></span>
                                                </form>                                            
                                            </div>
                                            <div class="comment__operate__item report">
                                                <i class="fa-regular fa-flag"></i>
                                                <span data-v-a42dab90="">รายงาน</span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            <% }); %>                        
                        </ul>
                    </div>
                        
                    </div>
                </div>

        </div>
        <!-- Section Right -->
        <div class="info" >
            <!-- Episodes -->
            <div class="flex flex-wrap w-full mb-20 gap-2" id="episodes-container">
                
            </div>
            
            </div>

                <div class="pc">
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6579807593228261"
                    crossorigin="anonymous"></script>
                <!-- Ads12 -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6579807593228261" data-ad-slot="3343866175"
                    data-ad-format="auto" data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                </div>
           <br>

            <!-- <div class="mt-8 w-full bg-white px-6 md:px-12 py-4 shadow-md rounded-md relative">
                <h2 style="font-size: 20px; font-weight: bold;">ให้เรทคะแนนเรื่องนี้</h2>
                <form action="/play/<%= video.videoid %>/rate" method="post" id="ratingForm">
                    <div class="rating-container">
                        <div class="rating">
                            <input type="radio" id="star5" name="rating" value="5">
                            <label for="star5"></label>
                            <input type="radio" id="star4" name="rating" value="4">
                            <label for="star4"></label>
                            <input type="radio" id="star3" name="rating" value="3">
                            <label for="star3"></label>
                            <input type="radio" id="star2" name="rating" value="2">
                            <label for="star2"></label>
                            <input type="radio" id="star1" name="rating" value="1">
                            <label for="star1"></label>
                        </div>
                        <div class="rating-number">
                            <%= video.ratings %> ดาว
                        </div>
                    </div>
                    <button type="submit">บันทึกคะแนน</button>
                </form>

            </div> -->


            <div id="scroll-bar-container"
                    class="fixed flex items-center justify-center bottom-20 right-5 w-[50px] h-[50px] rounded-full bg-sky-600">
                    <div class="flex items-center justify-center">

                        <!-- สำหรับนับถอนหลักแบบตัวเลข -->
                        <div id="countdown-timer" class="absolute text-xl font-bold text-white">60</div>

                        <!-- Scrool Timeout นับถอนหลังแบบหมุนรอบ -->
                        <div id="scroll-bar"
                    class="w-[60px] h-[60px] border-gray-800 border-2 rounded-full"></div>
                    </div>
                </div>
                

                <div id="popuppoint"
                    class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white p-4 rounded shadow-md"
                    style="display: none;">
                    
                </div>

        </div>

    </section>

    <!-- แจ้งเตือนต่างๆ -->
    <div class="alert_container">
        <div class="alert_text">ได้รับการตอบกลับแล้ว !!</div>
    </div>
    <%- include('../footer') %>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
        <script src="/js/video_player.js" defer></script>
        <!-- <script src="/js/CommentVideo.js" defer></script> -->
        <script src="/js/play.js" defer></script>
        <% if (usersesstion) {%>
            <script>
                // เริ่มการนับถอยหลังเมื่อโหลดหน้าเว็บ
                let countdown = 60;
                 let intervalId;

                    function startCountdown() {
                        countdown = 60;
                        intervalId = setInterval(() => {
                            countdown--;
                            updateCountdownUI(countdown);
                            if (countdown <= 0) {
                                clearInterval(intervalId);
                                const randomScore = [20, 50, 70, 100, 799, 909, 1000][Math.floor(Math.random() * 7)];
                                saveScoreToDatabase(randomScore);
                                showPopup(randomScore);
                                startCountdown();
                            }
                        }, 1000);
                    }

                    window.onbeforeunload = function() {
                        clearInterval(intervalId);
                    };

                function showPopup(score) {
                    const popuppoint = document.getElementById('popuppoint');
                    popuppoint.innerText = `คุณได้รับ ${score} คะแนน!`;
                    popuppoint.style.display = 'block';
                    setTimeout(() => {
                        popuppoint.style.display = 'none';
                    }, 6000); // ซ่อน Popup หลังจากแสดงเป็นเวลา 2 วินาที
                }
                // ฟังก์ชันสำหรับแสดงการนับถอยหลังบน UI
                function updateCountdownUI(countdown) {
                    document.getElementById('countdown-timer').innerText = countdown;
                }
                // ฟังก์ชันสำหรับบันทึกคะแนนลงในฐานข้อมูล
                function saveScoreToDatabase(score) {
                    fetch('/api/score', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId: '<%= usersesstion._id %>', score: score })
                    })
                        .then(response => response.json())
                        .then(data => console.log(data))
                        .catch(error => console.error('Error saving score:', error));
                }

                startCountdown();
            </script>
        <% } %>
        <script defer>
            function showLoadingIndicator() {
    document.querySelectorAll('.loading_container').forEach(item => {
        item.style.display = 'block';
    });
    document.querySelectorAll('.loading').forEach(item => {
        item.style.display = 'none';
    });
}

function hideLoadingIndicator() {
    document.querySelectorAll('.loading_container').forEach(item => {
        item.style.display = 'none';
    });
    document.querySelectorAll('.loading').forEach(item => {
        item.style.display = 'block';
    });
}

showLoadingIndicator();

window.addEventListener('load', function () {
    hideLoadingIndicator();
});

        </script>
        <!-- <script src="./js/pages/videoai.js"></script> -->
        <% if (typeof rating !=='undefined' && rating ) { %>
            <script defer>
                document.addEventListener('DOMContentLoaded', function () {
                    Swal.fire({
                        icon: 'success',
                        title: '<%= rating %>',
                    });
                });
            </script>
            <% } %>

</body>

</html>