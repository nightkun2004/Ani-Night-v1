<% forums.forEach(forum => { %>
    <% const totalReplies = forum.replies.length; %>
    <div id="reply-modal-<%= forum._id %>" class="modals">
        <div class="modal-content md:rounded-lg">
            <div class="border-b-2 p-5 sticky top-0 bg-white">
                <h2>ข้อความตอบกลับ: <%= totalReplies %></h2>
                <span class="close-modal text-2xl bg-gray-200 w-[50px] flex justify-center content-center drop-shadow-md" style="border-radius: 50px;" data-modal-close="reply-modal-<%= forum._id %>">x</span>
            </div>
            <% if (totalReplies > 0) { %>
                <ul>
                    <div class="loading_container">
                        <div class="loading-indicator loadingIndicator" id="loadingIndicator">
                            <div class="spinner"></div>
                            <p>กำลังประมวณผลข้อมูล</p>
                        </div>
                    </div>
                    <div class="loading" style="display: none;">
                        <% for (let i = 0; i < totalReplies; i++) { %>
                            <% const reply = forum.replies[i]; %>
                            <li class=" border-l p-2 flex content-center bg-gray-200 rounded-lg mt-2 mb-">
                                <div class="flex">
                                    <a href="/editor/<%= reply.username.username %>" target="_blank" rel="noopener noreferrer">
                                        <img src="/profiles/<%= reply.username.profile %>" alt="profile" class="w-10 h10" style="border-radius: 50px;">
                                    </a>
                                    <div class="relative flex items-center justify-between">
                                        <p class="pl-2"><%= reply.username.id.username %></p>
                                        <% 
                                       function formatTimeAgo(dateString) {
                                        const thaiMonths = [
                                            "มกราคม", "กุมภาพันธ์", "มีนาคม",
                                            "เมษายน", "พฤษภาคม", "มิถุนายน",
                                            "กรกฎาคม", "สิงหาคม", "กันยายน",
                                            "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                                        ];

                                        const date = new Date(dateString);
                                        const now = new Date();
                                        const diffInMilliseconds = now - date;

                                        // เวลาที่ผ่านมาในรูปแบบนาที
                                        const minutesAgo = Math.floor(diffInMilliseconds / (1000 * 60));

                                        // เวลาที่ผ่านมาในรูปแบบชั่วโมง
                                        const hoursAgo = Math.floor(minutesAgo / 60);

                                        // เวลาที่ผ่านมาในรูปแบบวัน
                                        const daysAgo = Math.floor(diffInMilliseconds / (1000 * 60 * 60 * 24));

                                        if (minutesAgo < 60) {
                                            // ถ้าน้อยกว่า 60 นาทีให้แสดงเป็นนาทีที่ผ่านมา
                                            return `ตอบกลับเมื่อ ${minutesAgo} นาทีที่แล้ว`;
                                        } else if (hoursAgo === 1) {
                                            // ถ้าเป็นหนึ่งชั่วโมงที่ผ่านมาให้แสดงเป็นหนึ่งชั่วโมงที่แล้ว
                                            return `ตอบกลับเมื่อ ${hoursAgo} ชั่วโมงที่แล้ว`;
                                        } else if (daysAgo === 1) {
                                            // ถ้าเป็นเมื่อวานนี้ให้แสดงเป็นเมื่อวานนี้
                                            return `ตอบกลับเมื่อเมื่อวานนี้`;
                                        } else {
                                            // นอกเหนือจากนี้ให้แสดงวันที่และเวลา
                                            const day = date.getDate();
                                            const month = thaiMonths[date.getMonth()];
                                            const year = date.getFullYear();
                                            const hour = date.getHours();
                                            const minute = date.getMinutes();
                                            return `${day} ${month} ${year} ${hour}:${minute}`;
                                        }
                                    }


                                        %>                                                   
                                    </div>                                                    
                                </div>
                                <div class="flex flex-col">
                                    <h2 class="text-sm text-slate-950"><%= reply.username.username %></h2>
                                    <%= reply.content %>
                                <p class="text-sm text-gray-400"><%= formatTimeAgo(reply.createdAt) %></p>
                                </div>
                            </li>
                        <% } %>
                    </div>
                </ul>
            <% } else { %>
                <p>ไม่มีข้อความตอบกลับ</p>
            <% } %>

            <div class="flex justify-center content-center m-2 sticky bottom-0 bg-white p-5 drop-shadow-md md:rounded-lg">
                <% if (usersesstion) { %>
                    <div class="reply-box flex flex-col mt-2 justify-center">
                        <input type="text" name="replybox" class="border-2 border-slate-200 outline-none text-left p-2 w-full h-[35px] rounded" placeholder="ตอบกลับโพสต์นี้">
                        <button data-forumid="<%= forum._id %>" class="bg-sky-500 rounded-lg mt-2 p-1 w-full text-white hover:bg-sky-800 btn-reply" type="button">ตอบ</button>
                    </div>  
               <% }  else { %>
                <button class="flex content-center text-1xl bg-sky-200 rounded-lg justify-center">
                    <i class='bx bxs-message-rounded-dots'></i>
                    เข้าสู่ระบบเพื่อตอบกลับ
                </button>
               <% }%>     
            </div>
        </div>
    </div>
<% }); %>